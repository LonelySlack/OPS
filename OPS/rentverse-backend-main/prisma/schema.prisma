generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [postgis, uuid_ossp(map: "uuid-ossp", schema: "extensions")]
}

/// Master jenis properti (mis: Apartemen, Rumah, Studio).
/// Dibuat terpisah agar bisa dikelola via admin tanpa redeploy.
model PropertyType {
  id          String     @id @default(uuid())
  code        String     @unique
  name        String
  description String?
  icon        String?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  properties  Property[]

  @@map("property_types")
}

/// Master fasilitas/amenitas (mis: AC, Kolam Renang).
model Amenity {
  id         String            @id @default(uuid())
  name       String            @unique
  category   String?
  properties PropertyAmenity[]

  @@map("amenities")
}

/// Akun pengguna (tenant, landlord, admin).
model User {
  id                String             @id @default(uuid())
  email             String             @unique
  firstName         String             @default("")
  lastName          String             @default("")
  name              String
  dateOfBirth       DateTime?
  phone             String?
  profilePicture    String?
  password          String
  role              Role               @default(USER)
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  verifiedAt        DateTime?
  googleId          String?            @unique
  facebookId        String?            @unique
  appleId           String?            @unique
  githubId          String?            @unique
  twitterId         String?            @unique
  mfaEnabled        Boolean            @default(false)
  mfaSecret         String?
  ActivityLog       ActivityLog[]
  leasesAsLandlord  Lease[]            @relation("LandlordLeases")
  leasesAsTenant    Lease[]            @relation("TenantLeases")
  approvals         ListingApproval[]  @relation("ReviewerApprovals")
  payments          Payment[]
  properties        Property[]         @relation("OwnerProperties")
  propertyFavorites PropertyFavorite[] @relation("PropertyFavorites")
  propertyRatings   PropertyRating[]   @relation("PropertyRatings")
  propertyViews     PropertyView[]     @relation("PropertyViews")
  SecurityAlert     SecurityAlert[]

  @@map("users")
}

/// Listing properti yang ditawarkan (detail fisik, lokasi, harga).
/// Gambar/Foto disimpan langsung di kolom `images` (array URL).
model Property {
  id             String                   @id @default(uuid())
  title          String
  description    String?
  address        String
  city           String
  state          String
  zipCode        String
  country        String                   @default("MY")
  price          Decimal                  @db.Decimal(12, 2)
  currencyCode   String                   @default("MYR")
  bedrooms       Int                      @default(0)
  bathrooms      Int                      @default(0)
  areaSqm        Float?
  furnished      Boolean                  @default(false)
  isAvailable    Boolean                  @default(true)
  /// Kumpulan URL gambar untuk listing ini (urutan = urutan tampilan).
  images         String[]                 @default([])
  latitude       Float?
  longitude      Float?
  placeId        String?
  projectName    String?
  developer      String?
  code           String                   @unique
  status         ListingStatus            @default(PENDING_REVIEW)
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt
  ownerId        String
  propertyTypeId String
  geom           Unsupported("geometry")?
  leases         Lease[]
  approvals      ListingApproval?
  predictions    PricePrediction[]
  owner          User                     @relation("OwnerProperties", fields: [ownerId], references: [id], onDelete: Cascade)
  propertyType   PropertyType             @relation(fields: [propertyTypeId], references: [id])
  amenities      PropertyAmenity[]
  favorites      PropertyFavorite[]
  ratings        PropertyRating[]
  views          PropertyView[]

  @@index([geom], map: "idx_properties_geom", type: Gist)
  @@index([latitude, longitude])
  @@index([city, state, country])
  @@index([status, isAvailable])
  @@map("properties")
}

/// Tabel pivot N:N antara Property dan Amenity.
model PropertyAmenity {
  propertyId String
  amenityId  String
  amenity    Amenity  @relation(fields: [amenityId], references: [id], onDelete: Cascade)
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@id([propertyId, amenityId])
  @@map("property_amenities")
}

/// Log review listing oleh admin (simple audit trail).
model ListingApproval {
  id         String         @id @default(uuid())
  propertyId String         @unique
  reviewerId String?
  status     ApprovalStatus @default(PENDING)
  notes      String?
  reviewedAt DateTime?
  createdAt  DateTime       @default(now())
  property   Property       @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  reviewer   User?          @relation("ReviewerApprovals", fields: [reviewerId], references: [id])

  @@index([status])
  @@map("listing_approvals")
}

/// Kontrak sewa jangka waktu antara landlord dan tenant.
model Lease {
  id                String           @id @default(uuid())
  propertyId        String           @map("property_id")
  tenantId          String           @map("tenant_id")
  landlordId        String           @map("landlord_id")
  startDate         DateTime         @map("start_date")
  endDate           DateTime         @map("end_date")
  rentAmount        Decimal
  currencyCode      String           @default("MYR")
  securityDeposit   Decimal?         @map("security_deposit")
  notes             String?          @map("notes")
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")
  tenantSignature   String?          @map("tenant_signature")
  landlordSignature String?          @map("landlord_signature")
  tenantSignedAt    DateTime?        @map("tenant_signed_at")
  landlordSignedAt  DateTime?        @map("landlord_signed_at")
  status            String           @default("PENDING")
  signatureStatus   SignatureStatus  @default(PENDING) @map("signature_status")
  invoices          Invoice[]
  landlord          User             @relation("LandlordLeases", fields: [landlordId], references: [id])
  property          Property         @relation(fields: [propertyId], references: [id])
  tenant            User             @relation("TenantLeases", fields: [tenantId], references: [id])
  agreement         RentalAgreement?

  @@map("leases")
}

/// Dokumen tagihan untuk lease (sewa/beban lainnya).
model Invoice {
  id           String        @id @default(uuid())
  leaseId      String
  type         InvoiceType   @default(RENT)
  amount       Decimal       @db.Decimal(12, 2)
  currencyCode String        @default("MYR")
  dueDate      DateTime
  status       InvoiceStatus @default(DUE)
  issuedAt     DateTime      @default(now())
  paidAt       DateTime?
  memo         String?
  lease        Lease         @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  payments     Payment[]

  @@index([leaseId, status, dueDate])
  @@map("invoices")
}

/// Pencatatan pembayaran invoice (mendukung cicilan/multi-part).
model Payment {
  id        String        @id @default(uuid())
  invoiceId String
  amount    Decimal       @db.Decimal(12, 2)
  method    PaymentMethod @default(BANK_TRANSFER)
  status    PaymentStatus @default(PENDING)
  paidAt    DateTime?
  txnRef    String?
  createdAt DateTime      @default(now())
  payerId   String?
  invoice   Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  payer     User?         @relation(fields: [payerId], references: [id])

  @@index([invoiceId, status])
  @@map("payments")
}

/// Perjanjian sewa (hasil generate PDF) untuk satu lease.
model RentalAgreement {
  id          String   @id @default(uuid())
  leaseId     String   @unique @map("lease_id")
  pdfUrl      String?
  publicId    String?
  fileName    String?
  fileSize    Int?
  generatedAt DateTime @default(now()) @map("generated_at")
  lease       Lease    @relation(fields: [leaseId], references: [id], onDelete: Cascade)

  @@map("rental_agreements")
}

/// Log prediksi harga (input mentah, harga prediksi, confidence, versi model).
model PricePrediction {
  id             String    @id @default(uuid())
  propertyId     String?
  inputs         Json
  predictedPrice Decimal   @db.Decimal(12, 2)
  confidence     Float
  modelVersion   String
  createdAt      DateTime  @default(now())
  property       Property? @relation(fields: [propertyId], references: [id])

  @@index([propertyId, modelVersion])
  @@map("price_predictions")
}

/// Log views/kunjungan ke detail property untuk analytics dan tracking popularitas.
model PropertyView {
  id         String   @id @default(uuid())
  propertyId String
  userId     String?
  ipAddress  String?
  userAgent  String?
  viewedAt   DateTime @default(now())
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user       User?    @relation("PropertyViews", fields: [userId], references: [id])

  @@index([propertyId, viewedAt])
  @@index([userId])
  @@map("property_views")
}

/// Rating dan review property oleh user yang sudah login.
model PropertyRating {
  id         String   @id @default(uuid())
  propertyId String
  userId     String
  rating     Int
  comment    String?
  ratedAt    DateTime @default(now())
  updatedAt  DateTime @updatedAt
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user       User     @relation("PropertyRatings", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([propertyId, userId])
  @@index([propertyId])
  @@index([userId])
  @@map("property_ratings")
}

/// Favorit property oleh user yang sudah login.
model PropertyFavorite {
  id          String   @id @default(uuid())
  propertyId  String
  userId      String
  favoritedAt DateTime @default(now())
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user        User     @relation("PropertyFavorites", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([propertyId, userId])
  @@index([propertyId])
  @@index([userId])
  @@index([userId, favoritedAt])
  @@map("property_favorites")
}

model ActivityLog {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  action    String
  status    String
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  details   Json?
  createdAt DateTime @default(now()) @map("created_at")
  user      User?    @relation(fields: [userId], references: [id])

  @@map("activity_logs")
}

model SecurityAlert {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  type       String
  message    String
  severity   String
  isResolved Boolean  @default(false) @map("is_resolved")
  createdAt  DateTime @default(now()) @map("created_at")
  user       User?    @relation(fields: [userId], references: [id])

  @@map("security_alerts")
}

/// Peran pengguna di sistem.
enum Role {
  USER
  ADMIN
}

/// Status listing untuk alur publikasi/approval.
enum ListingStatus {
  PENDING_REVIEW
  APPROVED
  REJECTED
}

/// Status approval per-riwayat keputusan admin.
enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

/// Jenis invoice/tagihan dalam sewa.
enum InvoiceType {
  RENT
  DEPOSIT
  UTILITY
  OTHER
}

/// Status invoice (penagihan).
enum InvoiceStatus {
  DUE
  PAID
  VOID
  REFUNDED
}

/// Metode pembayaran yang didukung.
enum PaymentMethod {
  BANK_TRANSFER
  CASH
  EWALLET
  CREDIT_CARD
}

/// Status transaksi pembayaran.
enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum SignatureStatus {
  PENDING
  TENANT_SIGNED
  LANDLORD_SIGNED
  FULLY_SIGNED
  REJECTED
}
